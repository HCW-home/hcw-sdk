import { Stream } from './stream';
import { Peer } from './peer';
import { Injectable } from '@angular/core';
import { BehaviorSubject } from 'rxjs';
import * as i0 from "@angular/core";
import * as i1 from "./log.service";
export class RemotePeersService {
    constructor(logger) {
        this.logger = logger;
        this._remotePeers = new BehaviorSubject([]);
        this.peers = [];
        this.remotePeers = this._remotePeers.asObservable();
    }
    updatePeers() {
        setTimeout(() => this._remotePeers.next(this.peers), 0);
    }
    clearPeers() {
        this._remotePeers = new BehaviorSubject([]);
        this.remotePeers = this._remotePeers.asObservable();
        this.peers = [];
    }
    newPeer(id) {
        this.logger.debug('New peer', id);
        const peer = new Peer();
        peer.id = id;
        peer.streams = [];
        this.addPeer(peer);
        this.updatePeers();
        return peer;
    }
    closePeer(id) {
        this.logger.debug('room "peerClosed" event [peerId:%o]', id);
        this.peers = this.peers.filter((peer) => peer.id !== id);
        this.updatePeers();
    }
    addPeer(peer) {
        this.peers.push(peer);
    }
    addPeers(peers) {
        this.logger.debug('Add peers ', peers);
        for (const peer of peers) {
            if (!this.peers.find(p => peer.id === p.id)) {
                this.logger.debug('adding peer [peerId: "%s"]', peer.id);
                this.peers.push({ id: peer.id, streams: [] });
            }
        }
        this.updatePeers();
    }
    newConsumer(consumer, peerId, type, producerPaused) {
        this.logger.debug('remote peers New consumer', consumer, peerId);
        let peer = this.peers.find(peer => peer.id === peerId);
        if (!peer) {
            this.logger.warn('Couldn\'t find peer', peerId, this.peers);
            peer = this.newPeer(peerId);
        }
        const existingStream = peer.streams.find(stream => { var _a; return ((_a = stream.consumer) === null || _a === void 0 ? void 0 : _a.appData.source) === consumer.appData.source; });
        if (existingStream) {
            existingStream.setConsumer(consumer);
        }
        else {
            const stream = new Stream();
            stream.peer = peer;
            stream.type = type;
            stream.producerPaused = producerPaused;
            stream.setConsumer(consumer);
            this.logger.debug('New stream created ', stream);
            peer.streams.push(stream);
        }
        this.updatePeers();
    }
    onConsumerLayerChanged(consumerId) {
        const stream = this.getStreamByConsumerId(consumerId);
        if (stream) {
            stream.consumerLayerChanged();
        }
    }
    getStreamByConsumerId(consumerId) {
        for (const peer of this.peers) {
            const stream = peer.streams.find(s => s.consumer.id === consumerId);
            if (stream) {
                return stream;
            }
        }
        return null;
    }
}
RemotePeersService.ɵfac = function RemotePeersService_Factory(t) { return new (t || RemotePeersService)(i0.ɵɵinject(i1.LogService)); };
RemotePeersService.ɵprov = i0.ɵɵdefineInjectable({ token: RemotePeersService, factory: RemotePeersService.ɵfac, providedIn: 'root' });
/*@__PURE__*/ (function () { i0.ɵsetClassMetadata(RemotePeersService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: i1.LogService }]; }, null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVtb3RlLXBlZXJzLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9odWctYW5ndWxhci1saWIvIiwic291cmNlcyI6WyJsaWIvcmVtb3RlLXBlZXJzLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUVsQyxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sUUFBUSxDQUFDO0FBRTlCLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLE1BQU0sQ0FBQzs7O0FBTXZDLE1BQU0sT0FBTyxrQkFBa0I7SUFNN0IsWUFBb0IsTUFBa0I7UUFBbEIsV0FBTSxHQUFOLE1BQU0sQ0FBWTtRQUgvQixpQkFBWSxHQUE0QixJQUFJLGVBQWUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUUvRCxVQUFLLEdBQVcsRUFBRSxDQUFBO1FBRXhCLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxZQUFZLEVBQUUsQ0FBQTtJQUNwRCxDQUFDO0lBR0YsV0FBVztRQUNULFVBQVUsQ0FBQyxHQUFHLEVBQUUsQ0FBRSxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUssQ0FBQyxDQUFDLENBQUE7SUFDN0QsQ0FBQztJQUVELFVBQVU7UUFDUixJQUFJLENBQUMsWUFBWSxHQUE0QixJQUFJLGVBQWUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNyRSxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDcEQsSUFBSSxDQUFDLEtBQUssR0FBRyxFQUFFLENBQUE7SUFDakIsQ0FBQztJQUNELE9BQU8sQ0FBQyxFQUFFO1FBQ1IsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsVUFBVSxFQUFFLEVBQUUsQ0FBQyxDQUFB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QyxRQUFRLENBQUMsQ0FBQTtZQUM1QixJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxxQkFBcUIsRUFBRSxNQUFNLENBQUMsQ0FBQTtZQUNoRCxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQTtTQUMxQjtRQUVELElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQTtJQUVwQixDQUFDO0lBRUQsc0JBQXNCLENBQUMsVUFBVTtRQUk3QixNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMscUJBQXFCLENBQUUsVUFBVSxDQUFDLENBQUE7UUFDdEQsSUFBSSxNQUFNLEVBQUU7WUFFVixNQUFNLENBQUMsb0JBQW9CLEVBQUUsQ0FBQTtTQUM5QjtJQUVMLENBQUM7SUFHRCxxQkFBcUIsQ0FBQyxVQUFrQjtRQUN0QyxLQUFLLE1BQU0sSUFBSSxJQUFJLElBQUksQ0FBQyxLQUFLLEVBQUU7WUFDN0IsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLEVBQUUsS0FBSyxVQUFVLENBQUMsQ0FBQTtZQUNuRSxJQUFJLE1BQU0sRUFBRTtnQkFDVixPQUFPLE1BQU0sQ0FBQTthQUNkO1NBQ0Y7UUFDRCxPQUFPLElBQUksQ0FBQTtJQUNiLENBQUM7O29GQXZHVSxrQkFBa0I7MERBQWxCLGtCQUFrQixXQUFsQixrQkFBa0IsbUJBRmpCLE1BQU07a0RBRVAsa0JBQWtCO2NBSDlCLFVBQVU7ZUFBQztnQkFDVixVQUFVLEVBQUUsTUFBTTthQUNuQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFN0cmVhbSB9IGZyb20gJy4vc3RyZWFtJztcbmltcG9ydCB7IExvZ1NlcnZpY2UgfSBmcm9tICcuL2xvZy5zZXJ2aWNlJztcbmltcG9ydCB7IFBlZXIgfSBmcm9tICcuL3BlZXInO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMvaW50ZXJuYWwvT2JzZXJ2YWJsZSc7XG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCAqIGFzIG1lZGlhc291cCBmcm9tICdtZWRpYXNvdXAtY2xpZW50JztcblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgUmVtb3RlUGVlcnNTZXJ2aWNlIHtcblxuXHRwdWJsaWMgcmVtb3RlUGVlcnM6IE9ic2VydmFibGU8UGVlcltdPjtcblx0cHJpdmF0ZSBfcmVtb3RlUGVlcnM6IEJlaGF2aW9yU3ViamVjdDxQZWVyW10+ID0gbmV3IEJlaGF2aW9yU3ViamVjdChbXSk7XG5cbiAgcHJpdmF0ZSBwZWVyczogUGVlcltdID0gW11cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBsb2dnZXI6IExvZ1NlcnZpY2UpIHtcbiAgICB0aGlzLnJlbW90ZVBlZXJzID0gdGhpcy5fcmVtb3RlUGVlcnMuYXNPYnNlcnZhYmxlKClcbiAgIH1cblxuXG4gIHVwZGF0ZVBlZXJzKCkge1xuICAgIHNldFRpbWVvdXQoKCkgPT4gXHR0aGlzLl9yZW1vdGVQZWVycy5uZXh0KHRoaXMucGVlcnMpICAgICwwKVxuICB9XG5cbiAgY2xlYXJQZWVycygpe1xuICAgIHRoaXMuX3JlbW90ZVBlZXJzID0gPEJlaGF2aW9yU3ViamVjdDxQZWVyW10+Pm5ldyBCZWhhdmlvclN1YmplY3QoW10pO1xuICAgIHRoaXMucmVtb3RlUGVlcnMgPSB0aGlzLl9yZW1vdGVQZWVycy5hc09ic2VydmFibGUoKTtcbiAgICB0aGlzLnBlZXJzID0gW11cbiAgfVxuICBuZXdQZWVyKGlkKTogUGVlciB7XG4gICAgdGhpcy5sb2dnZXIuZGVidWcoJ05ldyBwZWVyJywgaWQpXG4gICAgY29uc3QgcGVlciA9IG5ldyBQZWVyKClcbiAgICBwZWVyLmlkID0gaWQ7XG4gICAgcGVlci5zdHJlYW1zID0gW11cbiAgICB0aGlzLmFkZFBlZXIocGVlcilcbiAgICB0aGlzLnVwZGF0ZVBlZXJzKClcbiAgICByZXR1cm4gcGVlclxuICB9XG4gIGNsb3NlUGVlcihpZCl7XG5cdFx0dGhpcy5sb2dnZXIuZGVidWcoXG5cdFx0XHQncm9vbSBcInBlZXJDbG9zZWRcIiBldmVudCBbcGVlcklkOiVvXScsIGlkKTtcblxuICAgIHRoaXMucGVlcnMgPSB0aGlzLnBlZXJzLmZpbHRlcigocGVlcikgPT4gcGVlci5pZCAhPT0gaWQpO1xuICAgIHRoaXMudXBkYXRlUGVlcnMoKVxuICB9XG5cblxuICBhZGRQZWVyKHBlZXI6IFBlZXIpIHtcbiAgICB0aGlzLnBlZXJzLnB1c2gocGVlcilcbiAgfVxuXG4gIGFkZFBlZXJzKHBlZXJzKXtcbiAgICB0aGlzLmxvZ2dlci5kZWJ1ZygnQWRkIHBlZXJzICcsIHBlZXJzKVxuXHRcdGZvciAoY29uc3QgcGVlciBvZiBwZWVycylcblx0XHR7XG5cdFx0XHRpZiAoIXRoaXMucGVlcnMuZmluZChwPT5wZWVyLmlkID09PSBwLmlkKSlcblx0XHRcdHtcblx0XHRcdFx0dGhpcy5sb2dnZXIuZGVidWcoJ2FkZGluZyBwZWVyIFtwZWVySWQ6IFwiJXNcIl0nLCBwZWVyLmlkKTtcbiAgICAgICAgdGhpcy5wZWVycy5wdXNoKHsgaWQ6IHBlZXIuaWQsIHN0cmVhbXM6W10gfSk7XG5cdFx0XHR9XG5cdFx0fVxuXHRcdHRoaXMudXBkYXRlUGVlcnMoKTtcbiAgfVxuXG4gIG5ld0NvbnN1bWVyKGNvbnN1bWVyOiBtZWRpYXNvdXAudHlwZXMuQ29uc3VtZXIsIHBlZXJJZDogc3RyaW5nLCB0eXBlLCBwcm9kdWNlclBhdXNlZCkge1xuXG4gICAgdGhpcy5sb2dnZXIuZGVidWcoJ3JlbW90ZSBwZWVycyBOZXcgY29uc3VtZXInLCBjb25zdW1lciwgcGVlcklkKVxuICAgIGxldCBwZWVyID0gdGhpcy5wZWVycy5maW5kKHBlZXIgPT4gcGVlci5pZCA9PT0gcGVlcklkKVxuXG4gICAgaWYgKCFwZWVyKSB7XG4gICAgICB0aGlzLmxvZ2dlci53YXJuKCdDb3VsZG5cXCd0IGZpbmQgcGVlcicsIHBlZXJJZCwgdGhpcy5wZWVycylcbiAgICAgIHBlZXIgPSB0aGlzLm5ld1BlZXIocGVlcklkKVxuICAgIH1cbiAgICBjb25zdCBleGlzdGluZ1N0cmVhbSA9IHBlZXIuc3RyZWFtcy5maW5kKHN0cmVhbSA9PiBzdHJlYW0uY29uc3VtZXI/LmFwcERhdGEuc291cmNlID09PSBjb25zdW1lci5hcHBEYXRhLnNvdXJjZSlcblxuICAgIGlmIChleGlzdGluZ1N0cmVhbSkge1xuICAgICAgZXhpc3RpbmdTdHJlYW0uc2V0Q29uc3VtZXIoY29uc3VtZXIpXG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IHN0cmVhbSA9IG5ldyBTdHJlYW0oKVxuICAgICAgc3RyZWFtLnBlZXIgPSBwZWVyXG4gICAgICBzdHJlYW0udHlwZSA9IHR5cGU7XG4gICAgICBzdHJlYW0ucHJvZHVjZXJQYXVzZWQgPSBwcm9kdWNlclBhdXNlZDtcbiAgICAgIHN0cmVhbS5zZXRDb25zdW1lcihjb25zdW1lcilcbiAgICAgIHRoaXMubG9nZ2VyLmRlYnVnKCdOZXcgc3RyZWFtIGNyZWF0ZWQgJywgc3RyZWFtKVxuICAgICAgcGVlci5zdHJlYW1zLnB1c2goc3RyZWFtKVxuICAgIH1cblxuICAgIHRoaXMudXBkYXRlUGVlcnMoKVxuXG4gIH1cblxuICBvbkNvbnN1bWVyTGF5ZXJDaGFuZ2VkKGNvbnN1bWVySWQpIHtcblxuXG5cbiAgICAgIGNvbnN0IHN0cmVhbSA9IHRoaXMuZ2V0U3RyZWFtQnlDb25zdW1lcklkKCBjb25zdW1lcklkKVxuICAgICAgaWYgKHN0cmVhbSkge1xuXG4gICAgICAgIHN0cmVhbS5jb25zdW1lckxheWVyQ2hhbmdlZCgpXG4gICAgICB9XG5cbiAgfVxuXG5cbiAgZ2V0U3RyZWFtQnlDb25zdW1lcklkKGNvbnN1bWVySWQ6IHN0cmluZyk6IFN0cmVhbSB7XG4gICAgZm9yIChjb25zdCBwZWVyIG9mIHRoaXMucGVlcnMpIHtcbiAgICAgIGNvbnN0IHN0cmVhbSA9IHBlZXIuc3RyZWFtcy5maW5kKHMgPT4gcy5jb25zdW1lci5pZCA9PT0gY29uc3VtZXJJZClcbiAgICAgIGlmIChzdHJlYW0pIHtcbiAgICAgICAgcmV0dXJuIHN0cmVhbVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbnVsbFxuICB9XG59XG4iXX0=