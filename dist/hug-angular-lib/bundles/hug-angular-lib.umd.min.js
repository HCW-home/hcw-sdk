!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("ngx-logger"),require("rxjs"),require("rxjs/operators"),require("bowser"),require("mediasoup-client"),require("socket.io-client")):"function"==typeof define&&define.amd?define("hug-angular-lib",["exports","@angular/core","ngx-logger","rxjs","rxjs/operators","bowser","mediasoup-client","socket.io-client"],t):t((e=e||self)["hug-angular-lib"]={},e.ng.core,e.ngxLogger,e.rxjs,e.rxjs.operators,e.bowser,e.mediasoupClient,e.socket_ioClient)}(this,(function(e,t,r,n,i,s,o,a){"use strict";s=s&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s;
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */
var c=function(e,t){return(c=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)};var u=function(){return(u=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};function d(e,t,r,n){return new(r||(r=Promise))((function(i,s){function o(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}c((n=n.apply(e,t||[])).next())}))}function l(e,t){var r,n,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,n&&(i=2&s[0]?n.return:s[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,s[1])).done)return i;switch(n=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,n=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(i=o.trys,(i=i.length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=t.call(e,o)}catch(e){s=[6,e],n=0}finally{r=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}}Object.create;function h(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function p(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,s=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=s.next()).done;)o.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=s.return)&&r.call(s)}finally{if(i)throw i.error}}return o}function g(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(p(arguments[t]));return e}Object.create;var v=function(){function e(){}return e.prototype.ngOnInit=function(){},e.ɵfac=function(t){return new(t||e)},e.ɵcmp=t.ɵɵdefineComponent({type:e,selectors:[["lib-hug-angular-lib"]],decls:2,vars:0,template:function(e,r){1&e&&(t.ɵɵelementStart(0,"p"),t.ɵɵtext(1," hug-fuck shit address "),t.ɵɵelementEnd())},encapsulation:2}),e}();console.log("NGX logger");var m=function(){function e(){}return e.ɵmod=t.ɵɵdefineNgModule({type:e}),e.ɵinj=t.ɵɵdefineInjector({factory:function(t){return new(t||e)},providers:[r.NGXLogger],imports:[[r.LoggerModule.forRoot({level:r.NgxLoggerLevel.DEBUG})]]}),e}();("undefined"==typeof ngJitMode||ngJitMode)&&t.ɵɵsetNgModuleScope(m,{declarations:[v],imports:[r.LoggerModule],exports:[v]});var f=function(){function e(){this.onLayerChange=new n.Subject,this.mediaStream=new MediaStream}return e.prototype.setConsumer=function(e){this.consumer=e,this.streamId=e.id,this.kind=e.kind,this.mediaStream.addTrack(e.track)},e.prototype.consumerLayerChanged=function(){this.mediaStream=new MediaStream,this.mediaStream.addTrack(this.consumer.track),this.onLayerChange.next()},e.prototype.setProducer=function(e){this.producer=e,this.mediaStream.addTrack(e.track)},e}(),b=function(e){function t(r){var n=e.call(this,r)||this;return n.name="SocketTimeoutError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(n,t):n.stack=new Error(r).stack,n}return function(e,t){function r(){this.constructor=e}c(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}(t,e),t}(Error),_=function(){function e(e){this.logger=e,this._signalingBaseUrl="wss://conferences.iabsis.com",this._closed=!1,this.onDisconnected=new n.Subject,this.onReconnecting=new n.Subject,this.onReconnected=new n.Subject,this.onNewConsumer=new n.Subject,this.onNotification=new n.Subject}return e.prototype.init=function(e,t){var r=this;this._signalingUrl=this._signalingBaseUrl+"/?roomId="+e+"&peerId="+t,this._signalingSocket=a.io(this._signalingUrl),this.logger.debug("Initialize socket ",this._signalingUrl),this._signalingSocket.on("connect",(function(){r.logger.debug('signaling Peer "connect" event')})),this._signalingSocket.on("disconnect",(function(e){r.logger.warn('signaling Peer "disconnect" event [reason:"%s"]',e),r._closed||("io server disconnect"===e&&(r.onDisconnected.next(),r.close()),r.onReconnecting.next)})),this._signalingSocket.on("reconnect_failed",(function(){r.logger.warn('signaling Peer "reconnect_failed" event'),r.onDisconnected.next(),r.close()})),this._signalingSocket.on("reconnect",(function(e){r.logger.debug('signaling Peer "reconnect" event [attempts:"%s"]',e),r.onReconnected.next(e)})),this._signalingSocket.on("request",(function(e,t){return d(r,void 0,void 0,(function(){return l(this,(function(r){switch(this.logger.debug('socket "request" event [method:"%s", data:"%o"]',e.method,e.data),e.method){case"newConsumer":this.onNewConsumer.next(e.data),t();break;default:this.logger.error('unknown request.method "%s"',e.method),t(500,'unknown request.method "'+e.method+'"')}return[2]}))}))})),this._signalingSocket.on("notification",(function(e){r.logger.debug('socket "notification" event [method:"%s", data:"%o"]',e.method,e.data),r.onNotification.next(e)}))},e.prototype.close=function(){this._closed||(this._closed=!0,this.logger.debug("close()"),this._signalingSocket.close())},e.prototype.timeoutCallback=function(e){var t=!1,r=setTimeout((function(){t||(t=!0,e(new b("Request timed out")))}),2e4);return function(){for(var n=[],i=0;i<arguments.length;i++)n[i]=arguments[i];t||(t=!0,clearTimeout(r),e.apply(void 0,g(n)))}},e.prototype._sendRequest=function(e,t){var r=this;return new Promise((function(n,i){r._signalingSocket?r._signalingSocket.emit("request",{method:e,data:t},r.timeoutCallback((function(e,t){e?i(e):n(t)}))):i("No socket connection")}))},e.prototype.sendRequest=function(e,t){return d(this,void 0,void 0,(function(){var r,n,i;return l(this,(function(s){switch(s.label){case 0:this.logger.debug('sendRequest() [method:"%s", data:"%o"]',e,t),r=3,n=0,s.label=1;case 1:if(!(n<r))return[3,6];s.label=2;case 2:return s.trys.push([2,4,,5]),[4,this._sendRequest(e,t)];case 3:return[2,s.sent()];case 4:if(!((i=s.sent())instanceof b&&n<r))throw i;return this.logger.warn('sendRequest() | timeout, retrying [attempt:"%s"]',n),[3,5];case 5:return n++,[3,1];case 6:return[2]}}))}))},e.ɵfac=function(n){return new(n||e)(t.ɵɵinject(r.NGXLogger))},e.ɵprov=t.ɵɵdefineInjectable({token:e,factory:e.ɵfac,providedIn:"root"}),e}(),y=function(){this.streams=[]},w=function(){function e(e){this.logger=e,this._remotePeers=new n.BehaviorSubject([]),this.peers=[],this.remotePeers=this._remotePeers.asObservable()}return e.prototype.updatePeers=function(){var e=this;setTimeout((function(){return e._remotePeers.next(e.peers)}),0)},e.prototype.clearPeers=function(){this._remotePeers=new n.BehaviorSubject([]),this.remotePeers=this._remotePeers.asObservable(),this.peers=[]},e.prototype.newPeer=function(e){this.logger.debug("New peer",e);var t=new y;return t.id=e,t.streams=[],this.addPeer(t),this.updatePeers(),t},e.prototype.closePeer=function(e){this.logger.debug('room "peerClosed" event [peerId:%o]',e),this.peers=this.peers.filter((function(t){return t.id!==e})),this.updatePeers()},e.prototype.addPeer=function(e){this.peers.push(e)},e.prototype.addPeers=function(e){var t,r;this.logger.debug("Add peers ",e);var n=function(e){i.peers.find((function(t){return e.id===t.id}))||(i.logger.debug('adding peer [peerId: "%s"]',e.id),i.peers.push({id:e.id,streams:[]}))},i=this;try{for(var s=h(e),o=s.next();!o.done;o=s.next()){n(o.value)}}catch(e){t={error:e}}finally{try{o&&!o.done&&(r=s.return)&&r.call(s)}finally{if(t)throw t.error}}this.updatePeers()},e.prototype.newConsumer=function(e,t,r,n){this.logger.debug("remote peers New consumer",e,t);var i=this.peers.find((function(e){return e.id===t}));i||(this.logger.warn("Couldn't find peer",t,this.peers),i=this.newPeer(t));var s=i.streams.find((function(t){var r;return(null===(r=t.consumer)||void 0===r?void 0:r.appData.source)===e.appData.source}));if(s)s.setConsumer(e);else{var o=new f;o.peer=i,o.type=r,o.producerPaused=n,o.setConsumer(e),this.logger.debug("New stream created ",o),i.streams.push(o)}this.updatePeers()},e.prototype.onConsumerLayerChanged=function(e){var t=this.getStreamByConsumerId(e);t&&t.consumerLayerChanged()},e.prototype.getStreamByConsumerId=function(e){var t,r;try{for(var n=h(this.peers),i=n.next();!i.done;i=n.next()){var s=i.value.streams.find((function(t){return t.consumer.id===e}));if(s)return s}}catch(e){t={error:e}}finally{try{i&&!i.done&&(r=n.return)&&r.call(n)}finally{if(t)throw t.error}}return null},e.ɵfac=function(n){return new(n||e)(t.ɵɵinject(r.NGXLogger))},e.ɵprov=t.ɵɵdefineInjectable({token:e,factory:e.ɵfac,providedIn:"root"}),e}(),P=[{scaleResolutionDownBy:4},{scaleResolutionDownBy:2},{scaleResolutionDownBy:1}],S={low:{width:{ideal:320},aspectRatio:1.777},medium:{width:{ideal:640},aspectRatio:1.777},high:{width:{ideal:1280},aspectRatio:1.777},veryhigh:{width:{ideal:1920},aspectRatio:1.777},ultra:{width:{ideal:3840},aspectRatio:1.777}},D={optional:[{googDscp:!0}]},k=[{scaleResolutionDownBy:4,maxBitRate:1e5},{scaleResolutionDownBy:1,maxBitRate:12e5}],I=[{scalabilityMode:"S3T3_KEY"}],R=function(){function e(e,t,r){this.signalingService=e,this.logger=t,this.remotePeersService=r,this._sendTransport=null,this._recvTransport=null,this._closed=!1,this._produce=!0,this._forceTcp=!1,this.onCamProducing=new n.Subject}return e.prototype.init=function(e){var t=void 0===e?{}:e,r=t.peerId,n=void 0===r?null:r,i=t.produce,s=void 0===i||i,o=t.forceTcp,a=void 0!==o&&o,c=t.muted,u=void 0!==c&&c;if(!n)throw new Error("Missing peerId");this._produce=s,this._forceTcp=a,this._muted=u,this._device=this.deviceInfo(),this._peerId=n,this._roomId=null,this._mediasoupDevice=null,this._sendTransport=null,this._recvTransport=null,this._micProducer=null,this._hark=null,this._harkStream=null,this._webcamProducer=null,this._extraVideoProducers=new Map,this._webcams={},this._audioDevices={},this._audioOutputDevices={},this._consumers=new Map,this._useSimulcast=!0},e.prototype.close=function(){this._closed||(this._closed=!0,this.logger.debug("close()"),this.signalingService.close(),this._sendTransport&&this._sendTransport.close(),this._recvTransport&&this._recvTransport.close())},e.prototype._startDevicesListener=function(){var e=this;navigator.mediaDevices.addEventListener("devicechange",(function(){return d(e,void 0,void 0,(function(){return l(this,(function(e){switch(e.label){case 0:return this.logger.debug("_startDevicesListener() | navigator.mediaDevices.ondevicechange"),[4,this._updateAudioDevices()];case 1:return e.sent(),[4,this._updateWebcams()];case 2:return e.sent(),[4,this._updateAudioOutputDevices()];case 3:return e.sent(),[2]}}))}))}))},e.prototype.muteMic=function(){return d(this,void 0,void 0,(function(){var e;return l(this,(function(t){switch(t.label){case 0:this.logger.debug("muteMic()"),this._micProducer.pause(),t.label=1;case 1:return t.trys.push([1,3,,4]),[4,this.signalingService.sendRequest("pauseProducer",{producerId:this._micProducer.id})];case 2:return t.sent(),[3,4];case 3:return e=t.sent(),this.logger.error('muteMic() [error:"%o"]',e),[3,4];case 4:return[2]}}))}))},e.prototype.unmuteMic=function(){return d(this,void 0,void 0,(function(){var e;return l(this,(function(t){switch(t.label){case 0:return this.logger.debug("unmuteMic()"),this._micProducer?[3,1]:(this.updateMic({start:!0}),[3,5]);case 1:this._micProducer.resume(),t.label=2;case 2:return t.trys.push([2,4,,5]),[4,this.signalingService.sendRequest("resumeProducer",{producerId:this._micProducer.id})];case 3:return t.sent(),[3,5];case 4:return e=t.sent(),this.logger.error('unmuteMic() [error:"%o"]',e),[3,5];case 5:return[2]}}))}))},e.prototype.changeAudioOutputDevice=function(e){return d(this,void 0,void 0,(function(){var t;return l(this,(function(r){switch(r.label){case 0:this.logger.debug('changeAudioOutputDevice() [deviceId:"%s"]',e),r.label=1;case 1:if(r.trys.push([1,3,,4]),!this._audioOutputDevices[e])throw new Error("Selected audio output device no longer available");return[4,this._updateAudioOutputDevices()];case 2:return r.sent(),[3,4];case 3:return t=r.sent(),this.logger.error('changeAudioOutputDevice() [error:"%o"]',t),[3,4];case 4:return[2]}}))}))},e.prototype.updateMic=function(e){var t=void 0===e?{}:e,r=t.start,n=void 0!==r&&r,i=t.restart,s=void 0===i?"firefox"!==this._device.flag:i,o=t.newDeviceId,a=void 0===o?null:o;return d(this,void 0,void 0,(function(){var e,t,r,i,o,c,u,d,h,g,v,m,f,b,_,y,w,P,S,D,k,I,R,C,x,T,j,M,O,q,A=this;return l(this,(function(l){switch(l.label){case 0:this.logger.debug('updateMic() [start:"%s", restart:"%s", newDeviceId:"%s"]',n,s,a),l.label=1;case 1:if(l.trys.push([1,13,,14]),!this._mediasoupDevice.canProduce("audio"))throw new Error("cannot produce audio");if(a&&!s)throw new Error("changing device requires restart");return[4,this._getAudioDeviceId()];case 2:if(t=l.sent(),!this._audioDevices[t])throw new Error("no audio devices");return r=!1,i=!0,o=!0,d=void 0===(u=(c={}).sampleRate)?96e3:u,g=void 0===(h=c.channelCount)?1:h,m=void 0===(v=c.volume)?1:v,b=void 0===(f=c.sampleSize)?16:f,y=void 0!==(_=c.opusStereo)&&_,P=void 0===(w=c.opusDtx)||w,D=void 0===(S=c.opusFec)||S,I=void 0===(k=c.opusPtime)?20:k,C=void 0===(R=c.opusMaxPlaybackRate)?96e3:R,s&&this._micProducer||n?this._micProducer?[4,this.disableMic()]:[3,4]:[3,7];case 3:l.sent(),l.label=4;case 4:return[4,navigator.mediaDevices.getUserMedia({audio:{deviceId:{ideal:t},sampleRate:d,channelCount:g,volume:m,autoGainControl:r,echoCancellation:i,noiseSuppression:o,sampleSize:b}})];case 5:return x=l.sent(),q=p(x.getAudioTracks(),1),e=q[0],e.getSettings().deviceId,T=this,[4,this._sendTransport.produce({track:e,codecOptions:{opusStereo:y,opusDtx:P,opusFec:D,opusPtime:I,opusMaxPlaybackRate:C},appData:{source:"mic"}})];case 6:return T._micProducer=l.sent(),this._micProducer.on("transportclose",(function(){A._micProducer=null})),this._micProducer.on("trackended",(function(){A.disableMic()})),this._micProducer.volume=0,[3,11];case 7:return this._micProducer?[4,(e=this._micProducer.track).applyConstraints({sampleRate:d,channelCount:g,volume:m,autoGainControl:r,echoCancellation:i,noiseSuppression:o,sampleSize:b})]:[3,11];case 8:return l.sent(),null==this._harkStream?[3,11]:(j=p(this._harkStream.getAudioTracks(),1),M=j[0],M?[4,M.applyConstraints({sampleRate:d,channelCount:g,volume:m,autoGainControl:r,echoCancellation:i,noiseSuppression:o,sampleSize:b})]:[3,10]);case 9:l.sent(),l.label=10;case 10:l.label=11;case 11:return[4,this._updateAudioDevices()];case 12:return l.sent(),[3,14];case 13:return O=l.sent(),this.logger.error('updateMic() [error:"%o"]',O),e&&e.stop(),[3,14];case 14:return[2]}}))}))},e.prototype.updateWebcam=function(e){var t=void 0===e?{}:e,r=(t.init,t.start),n=void 0!==r&&r,i=t.restart,s=void 0!==i&&i,o=t.newDeviceId,a=void 0===o?null:o,c=t.newResolution,g=void 0===c?null:c,v=t.newFrameRate,m=void 0===v?null:v;return d(this,void 0,void 0,(function(){var e,t,r,i,o,c,d,v,b,_,y,w,D,R,C,x,T,j,M=this;return l(this,(function(l){switch(l.label){case 0:this.logger.debug('updateWebcam() [start:"%s", restart:"%s", newDeviceId:"%s", newResolution:"%s", newFrameRate:"%s"]',n,s,a,g,m),l.label=1;case 1:if(l.trys.push([1,21,,22]),!this._mediasoupDevice.canProduce("video"))throw new Error("cannot produce video");if(a&&!s)throw new Error("changing device requires restart");return!1,[4,this._getWebcamDeviceId()];case 2:if(t=l.sent(),!this._webcams[t])throw new Error("no webcam devices");return r="medium",i=15,s&&this._webcamProducer||n?this._webcamProducer?[4,this.disableWebcam()]:[3,4]:[3,10];case 3:l.sent(),l.label=4;case 4:return[4,navigator.mediaDevices.getUserMedia({video:u(u({deviceId:{ideal:t}},S[r]),{frameRate:i})})];case 5:return o=l.sent(),x=p(o.getVideoTracks(),1),e=x[0],e.getSettings().deviceId,this._useSimulcast?(c=this._mediasoupDevice.rtpCapabilities.codecs.find((function(e){return"video"===e.kind})),d=void 0,d="video/vp9"===c.mimeType.toLowerCase()?I:P||k,v=this,[4,this._sendTransport.produce({track:e,encodings:d,codecOptions:{videoGoogleStartBitrate:1e3},appData:{source:"webcam"}})]):[3,7];case 6:return v._webcamProducer=l.sent(),[3,9];case 7:return b=this,[4,this._sendTransport.produce({track:e,appData:{source:"webcam"}})];case 8:b._webcamProducer=l.sent(),l.label=9;case 9:return(_=new f).setProducer(this._webcamProducer),this.onCamProducing.next(_),this._webcamProducer.on("transportclose",(function(){M._webcamProducer=null})),this._webcamProducer.on("trackended",(function(){M.disableWebcam()})),[3,19];case 10:return this._webcamProducer?[4,(e=this._webcamProducer.track).applyConstraints(u(u({},S[r]),{frameRate:i}))]:[3,19];case 11:l.sent(),l.label=12;case 12:l.trys.push([12,17,18,19]),y=h(this._extraVideoProducers.values()),w=y.next(),l.label=13;case 13:return w.done?[3,16]:(D=w.value,[4,(e=D.track).applyConstraints(u(u({},S[r]),{frameRate:i}))]);case 14:l.sent(),l.label=15;case 15:return w=y.next(),[3,13];case 16:return[3,19];case 17:return R=l.sent(),T={error:R},[3,19];case 18:try{w&&!w.done&&(j=y.return)&&j.call(y)}finally{if(T)throw T.error}return[7];case 19:return[4,this._updateWebcams()];case 20:return l.sent(),[3,22];case 21:return C=l.sent(),this.logger.error('updateWebcam() [error:"%o"]',C),e&&e.stop(),[3,22];case 22:return[2]}}))}))},e.prototype.closeMeeting=function(){return d(this,void 0,void 0,(function(){var e;return l(this,(function(t){switch(t.label){case 0:this.logger.debug("closeMeeting()"),t.label=1;case 1:return t.trys.push([1,3,,4]),[4,this.signalingService.sendRequest("moderator:closeMeeting")];case 2:return t.sent(),[3,4];case 3:return e=t.sent(),this.logger.error('closeMeeting() [error:"%o"]',e),[3,4];case 4:return[2]}}))}))},e.prototype.modifyPeerConsumer=function(e,t,r){return d(this,void 0,void 0,(function(){var n,i,s,o,a,c,u;return l(this,(function(d){switch(d.label){case 0:this.logger.debug('modifyPeerConsumer() [peerId:"%s", type:"%s"]',e,t),d.label=1;case 1:d.trys.push([1,12,,13]),d.label=2;case 2:d.trys.push([2,9,10,11]),n=h(this._consumers.values()),i=n.next(),d.label=3;case 3:return i.done?[3,8]:(s=i.value).appData.peerId!==e||s.appData.source!==t?[3,7]:r?[4,this._pauseConsumer(s)]:[3,5];case 4:return d.sent(),[3,7];case 5:return[4,this._resumeConsumer(s)];case 6:d.sent(),d.label=7;case 7:return i=n.next(),[3,3];case 8:return[3,11];case 9:return o=d.sent(),c={error:o},[3,11];case 10:try{i&&!i.done&&(u=n.return)&&u.call(n)}finally{if(c)throw c.error}return[7];case 11:return[3,13];case 12:return a=d.sent(),this.logger.error('modifyPeerConsumer() [error:"%o"]',a),[3,13];case 13:return[2]}}))}))},e.prototype._pauseConsumer=function(e){return d(this,void 0,void 0,(function(){var t;return l(this,(function(r){switch(r.label){case 0:if(this.logger.debug('_pauseConsumer() [consumer:"%o"]',e),e.paused||e.closed)return[2];r.label=1;case 1:return r.trys.push([1,3,,4]),[4,this.signalingService.sendRequest("pauseConsumer",{consumerId:e.id})];case 2:return r.sent(),e.pause(),[3,4];case 3:return t=r.sent(),this.logger.error('_pauseConsumer() [error:"%o"]',t),[3,4];case 4:return[2]}}))}))},e.prototype._resumeConsumer=function(e){return d(this,void 0,void 0,(function(){var t;return l(this,(function(r){switch(r.label){case 0:if(this.logger.debug('_resumeConsumer() [consumer:"%o"]',e),!e.paused||e.closed)return[2];r.label=1;case 1:return r.trys.push([1,3,,4]),[4,this.signalingService.sendRequest("resumeConsumer",{consumerId:e.id})];case 2:return r.sent(),e.resume(),[3,4];case 3:return t=r.sent(),this.logger.error('_resumeConsumer() [error:"%o"]',t),[3,4];case 4:return[2]}}))}))},e.prototype.join=function(e){var t=e.roomId,r=e.joinVideo,n=e.joinAudio;return d(this,void 0,void 0,(function(){var e=this;return l(this,(function(s){return this._roomId=t,this.signalingService.init(t,this._peerId),this.signalingService.onDisconnected.subscribe((function(){})),this.signalingService.onReconnecting.subscribe((function(){e._webcamProducer&&(e._webcamProducer.close(),e._webcamProducer=null),e._micProducer&&(e._micProducer.close(),e._micProducer=null),e._sendTransport&&(e._sendTransport.close(),e._sendTransport=null),e._recvTransport&&(e._recvTransport.close(),e._recvTransport=null),e.remotePeersService.clearPeers()})),this.signalingService.onNewConsumer.pipe(i.switchMap((function(t){return d(e,void 0,void 0,(function(){var e,r,n,i,s,o,a,c,d,h=this;return l(this,(function(l){switch(l.label){case 0:return e=t.peerId,r=t.producerId,n=t.id,i=t.kind,s=t.rtpParameters,o=t.type,a=t.appData,c=t.producerPaused,[4,this._recvTransport.consume({id:n,producerId:r,kind:i,rtpParameters:s,appData:u(u({},a),{peerId:e})})];case 1:return d=l.sent(),this._consumers.set(d.id,d),d.on("transportclose",(function(){h._consumers.delete(d.id)})),this.remotePeersService.newConsumer(d,e,o,c),[2]}}))}))}))).subscribe(),this.signalingService.onNotification.pipe(i.switchMap((function(t){return d(e,void 0,void 0,(function(){var e,i,s,o,a,c,u,d,h,p;return l(this,(function(l){switch(l.label){case 0:this.logger.debug('socket "notification" event [method:"%s", data:"%o"]',t.method,t.data),l.label=1;case 1:switch(l.trys.push([1,16,,17]),t.method){case"producerScore":return[3,2];case"newPeer":return[3,3];case"peerClosed":return[3,4];case"consumerClosed":return[3,5];case"consumerPaused":return[3,6];case"consumerResumed":return[3,7];case"consumerLayersChanged":return[3,8];case"consumerScore":return[3,9];case"roomBack":return[3,10];case"roomReady":return[3,12]}return[3,14];case 2:return e=t.data,e.producerId,e.score,[3,15];case 3:return i=t.data,s=i.id,i.displayName,i.picture,i.roles,this.remotePeersService.newPeer(s),[3,15];case 4:return o=t.data.peerId,this.remotePeersService.closePeer(o),[3,15];case 5:return d=t.data.consumerId,(c=this._consumers.get(d))?(c.close(),null!=c.hark&&c.hark.stop(),this._consumers.delete(d),o=c.appData.peerId,[3,15]):[3,15];case 6:case 7:return d=t.data.consumerId,c=this._consumers.get(d),[3,15];case 8:return a=t.data,d=a.consumerId,a.spatialLayer,a.temporalLayer,(c=this._consumers.get(d))?(this.remotePeersService.onConsumerLayerChanged(d),[3,15]):[3,15];case 9:return u=t.data,d=u.consumerId,u.score,[3,15];case 10:return[4,this._joinRoom({joinVideo:r,joinAudio:n})];case 11:return l.sent(),[3,15];case 12:return h=t.data.turnServers,this._turnServers=h,[4,this._joinRoom({joinVideo:r,joinAudio:n})];case 13:return l.sent(),[3,15];case 14:l.label=15;case 15:return[3,17];case 16:return p=l.sent(),this.logger.error('error on socket "notification" event [error:"%o"]',p),[3,17];case 17:return[2]}}))}))}))).subscribe(),[2]}))}))},e.prototype._updateAudioDevices=function(){return d(this,void 0,void 0,(function(){var e,t,r,n,i,s,o;return l(this,(function(a){switch(a.label){case 0:this.logger.debug("_updateAudioDevices()"),this._audioDevices={},a.label=1;case 1:return a.trys.push([1,3,,4]),this.logger.debug("_updateAudioDevices() | calling enumerateDevices()"),[4,navigator.mediaDevices.enumerateDevices()];case 2:e=a.sent();try{for(t=h(e),r=t.next();!r.done;r=t.next())"audioinput"===(n=r.value).kind&&(this._audioDevices[n.deviceId]=n)}catch(e){s={error:e}}finally{try{r&&!r.done&&(o=t.return)&&o.call(t)}finally{if(s)throw s.error}}return[3,4];case 3:return i=a.sent(),this.logger.error('_updateAudioDevices() [error:"%o"]',i),[3,4];case 4:return[2]}}))}))},e.prototype._updateWebcams=function(){return d(this,void 0,void 0,(function(){var e,t,r,n,i,s,o;return l(this,(function(a){switch(a.label){case 0:this.logger.debug("_updateWebcams()"),this._webcams={},a.label=1;case 1:return a.trys.push([1,3,,4]),this.logger.debug("_updateWebcams() | calling enumerateDevices()"),[4,navigator.mediaDevices.enumerateDevices()];case 2:e=a.sent();try{for(t=h(e),r=t.next();!r.done;r=t.next())"videoinput"===(n=r.value).kind&&(this._webcams[n.deviceId]=n)}catch(e){s={error:e}}finally{try{r&&!r.done&&(o=t.return)&&o.call(t)}finally{if(s)throw s.error}}return[3,4];case 3:return i=a.sent(),this.logger.error('_updateWebcams() [error:"%o"]',i),[3,4];case 4:return[2]}}))}))},e.prototype.disableWebcam=function(){return d(this,void 0,void 0,(function(){var e;return l(this,(function(t){switch(t.label){case 0:if(this.logger.debug("disableWebcam()"),!this._webcamProducer)return[2];this._webcamProducer.close(),t.label=1;case 1:return t.trys.push([1,3,,4]),[4,this.signalingService.sendRequest("closeProducer",{producerId:this._webcamProducer.id})];case 2:return t.sent(),[3,4];case 3:return e=t.sent(),this.logger.error('disableWebcam() [error:"%o"]',e),[3,4];case 4:return this._webcamProducer=null,[2]}}))}))},e.prototype.disableMic=function(){return d(this,void 0,void 0,(function(){var e;return l(this,(function(t){switch(t.label){case 0:if(this.logger.debug("disableMic()"),!this._micProducer)return[2];this._micProducer.close(),t.label=1;case 1:return t.trys.push([1,3,,4]),[4,this.signalingService.sendRequest("closeProducer",{producerId:this._micProducer.id})];case 2:return t.sent(),[3,4];case 3:return e=t.sent(),this.logger.error('disableMic() [error:"%o"]',e),[3,4];case 4:return this._micProducer=null,[2]}}))}))},e.prototype._getWebcamDeviceId=function(){return d(this,void 0,void 0,(function(){var e,t;return l(this,(function(r){switch(r.label){case 0:this.logger.debug("_getWebcamDeviceId()"),r.label=1;case 1:return r.trys.push([1,3,,4]),this.logger.debug("_getWebcamDeviceId() | calling _updateWebcams()"),[4,this._updateWebcams()];case 2:return r.sent(),null,[2,(e=Object.values(this._webcams))[0]?e[0].deviceId:null];case 3:return t=r.sent(),this.logger.error('_getWebcamDeviceId() [error:"%o"]',t),[3,4];case 4:return[2]}}))}))},e.prototype._getAudioDeviceId=function(){return d(this,void 0,void 0,(function(){var e,t;return l(this,(function(r){switch(r.label){case 0:this.logger.debug("_getAudioDeviceId()"),r.label=1;case 1:return r.trys.push([1,3,,4]),this.logger.debug("_getAudioDeviceId() | calling _updateAudioDeviceId()"),[4,this._updateAudioDevices()];case 2:return r.sent(),null,[2,(e=Object.values(this._audioDevices))[0]?e[0].deviceId:null];case 3:return t=r.sent(),this.logger.error('_getAudioDeviceId() [error:"%o"]',t),[3,4];case 4:return[2]}}))}))},e.prototype._updateAudioOutputDevices=function(){return d(this,void 0,void 0,(function(){var e,t,r,n,i,s,o;return l(this,(function(a){switch(a.label){case 0:this.logger.debug("_updateAudioOutputDevices()"),this._audioOutputDevices={},a.label=1;case 1:return a.trys.push([1,3,,4]),this.logger.debug("_updateAudioOutputDevices() | calling enumerateDevices()"),[4,navigator.mediaDevices.enumerateDevices()];case 2:e=a.sent();try{for(t=h(e),r=t.next();!r.done;r=t.next())"audiooutput"===(n=r.value).kind&&(this._audioOutputDevices[n.deviceId]=n)}catch(e){s={error:e}}finally{try{r&&!r.done&&(o=t.return)&&o.call(t)}finally{if(s)throw s.error}}return[3,4];case 3:return i=a.sent(),this.logger.error('_updateAudioOutputDevices() [error:"%o"]',i),[3,4];case 4:return[2]}}))}))},e.prototype._joinRoom=function(e){var t=e.joinVideo,r=e.joinAudio;return d(this,void 0,void 0,(function(){var e,n,i,s,a,c,u,h,p,g,v,m,f,b,_,y,w,P,S=this;return l(this,(function(k){switch(k.label){case 0:this.logger.debug("_joinRoom()"),e="Guest "+(Math.floor(9e4*Math.random())+1e4),k.label=1;case 1:return k.trys.push([1,11,,12]),this._mediasoupDevice=new o.Device,[4,this.signalingService.sendRequest("getRouterRtpCapabilities")];case 2:return(n=k.sent()).headerExtensions=n.headerExtensions.filter((function(e){return"urn:3gpp:video-orientation"!==e.uri})),[4,this._mediasoupDevice.load({routerRtpCapabilities:n})];case 3:return k.sent(),this._produce?[4,this.signalingService.sendRequest("createWebRtcTransport",{forceTcp:this._forceTcp,producing:!0,consuming:!1})]:[3,5];case 4:i=k.sent(),s=i.id,a=i.iceParameters,c=i.iceCandidates,u=i.dtlsParameters,this._sendTransport=this._mediasoupDevice.createSendTransport({id:s,iceParameters:a,iceCandidates:c,dtlsParameters:u,iceServers:this._turnServers,iceTransportPolicy:"firefox"===this._device.flag&&this._turnServers?"relay":void 0,proprietaryConstraints:D}),this._sendTransport.on("connect",(function(e,t,r){var n=e.dtlsParameters;S.signalingService.sendRequest("connectWebRtcTransport",{transportId:S._sendTransport.id,dtlsParameters:n}).then(t).catch(r)})),this._sendTransport.on("produce",(function(e,t,r){var n=e.kind,i=e.rtpParameters,s=e.appData;return d(S,void 0,void 0,(function(){var e,o;return l(this,(function(a){switch(a.label){case 0:return a.trys.push([0,2,,3]),[4,this.signalingService.sendRequest("produce",{transportId:this._sendTransport.id,kind:n,rtpParameters:i,appData:s})];case 1:return e=a.sent().id,t({id:e}),[3,3];case 2:return o=a.sent(),r(o),[3,3];case 3:return[2]}}))}))})),k.label=5;case 5:return[4,this.signalingService.sendRequest("createWebRtcTransport",{forceTcp:this._forceTcp,producing:!1,consuming:!0})];case 6:return h=k.sent(),p=h.id,g=h.iceParameters,v=h.iceCandidates,m=h.dtlsParameters,this._recvTransport=this._mediasoupDevice.createRecvTransport({id:p,iceParameters:g,iceCandidates:v,dtlsParameters:m,iceServers:this._turnServers,iceTransportPolicy:"firefox"===this._device.flag&&this._turnServers?"relay":void 0}),this._recvTransport.on("connect",(function(e,t,r){var n=e.dtlsParameters;S.signalingService.sendRequest("connectWebRtcTransport",{transportId:S._recvTransport.id,dtlsParameters:n}).then(t).catch(r)})),[4,this.signalingService.sendRequest("join",{displayName:e,rtpCapabilities:this._mediasoupDevice.rtpCapabilities})];case 7:return f=k.sent(),b=f.authenticated,_=f.roles,y=f.peers,f.tracker,f.roomPermissions,w=f.userRoles,f.allowWhenRoleMissing,f.chatHistory,f.fileHistory,f.lastNHistory,f.locked,f.lobbyPeers,f.accessCode,this.logger.debug('_joinRoom() joined [authenticated:"%s", peers:"%o", roles:"%o", userRoles:"%o"]',b,y,_,w),this.logger.debug("join audio",r,"can produce audio",this._mediasoupDevice.canProduce("audio")," this._muted",this._muted),this._produce?(t&&this.updateWebcam({init:!0,start:!0}),r&&this._mediasoupDevice.canProduce("audio")?this._muted?[3,9]:[4,this.updateMic({start:!0})]:[3,9]):[3,9];case 8:k.sent(),k.label=9;case 9:return[4,this._updateAudioOutputDevices()];case 10:return k.sent(),this.remotePeersService.addPeers(y),[3,12];case 11:return P=k.sent(),this.logger.error('_joinRoom() [error:"%o"]',P),this.close(),[3,12];case 12:return[2]}}))}))},e.prototype.deviceInfo=function(){var e=navigator.userAgent,t=s.getParser(e);return{flag:t.satisfies({chrome:">=0",chromium:">=0"})?"chrome":t.satisfies({firefox:">=0"})?"firefox":t.satisfies({safari:">=0"})?"safari":t.satisfies({opera:">=0"})?"opera":t.satisfies({"microsoft edge":">=0"})?"edge":"unknown",os:t.getOSName(!0),platform:t.getPlatformType(!0),name:t.getBrowserName(!0),version:t.getBrowserVersion(),bowser:t}},e.ɵfac=function(n){return new(n||e)(t.ɵɵinject(_),t.ɵɵinject(r.NGXLogger),t.ɵɵinject(w))},e.ɵprov=t.ɵɵdefineInjectable({token:e,factory:e.ɵfac,providedIn:"root"}),e}();Object.defineProperty(e,"LogService",{enumerable:!0,get:function(){return r.NGXLogger}}),e.HugAngularLibComponent=v,e.HugAngularLibModule=m,e.RemotePeersService=w,e.RoomService=R,e.Stream=f,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=hug-angular-lib.umd.min.js.map