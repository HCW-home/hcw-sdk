!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("ngx-logger"),require("rxjs"),require("rxjs/operators"),require("bowser"),require("mediasoup-client"),require("hark"),require("socket.io-client")):"function"==typeof define&&define.amd?define("hug-angular-lib",["exports","@angular/core","ngx-logger","rxjs","rxjs/operators","bowser","mediasoup-client","hark","socket.io-client"],t):t((e=e||self)["hug-angular-lib"]={},e.ng.core,e.ngxLogger,e.rxjs,e.rxjs.operators,e.bowser,e.mediasoupClient,e.hark,e.socket_ioClient)}(this,(function(e,t,r,n,s,i,o,a,c){"use strict";i=i&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i,a=a&&Object.prototype.hasOwnProperty.call(a,"default")?a.default:a;
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */
var u=function(e,t){return(u=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)};var d=function(){return(d=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var s in t=arguments[r])Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s]);return e}).apply(this,arguments)};function l(e,t,r,n){return new(r||(r=Promise))((function(s,i){function o(e){try{c(n.next(e))}catch(e){i(e)}}function a(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}c((n=n.apply(e,t||[])).next())}))}function h(e,t){var r,n,s,i,o={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,n&&(s=2&i[0]?n.return:i[0]?n.throw||((s=n.return)&&s.call(n),0):n.next)&&!(s=s.call(n,i[1])).done)return s;switch(n=0,s&&(i=[2&i[0],s.value]),i[0]){case 0:case 1:s=i;break;case 4:return o.label++,{value:i[1],done:!1};case 5:o.label++,n=i[1],i=[0];continue;case 7:i=o.ops.pop(),o.trys.pop();continue;default:if(!(s=o.trys,(s=s.length>0&&s[s.length-1])||6!==i[0]&&2!==i[0])){o=0;continue}if(3===i[0]&&(!s||i[1]>s[0]&&i[1]<s[3])){o.label=i[1];break}if(6===i[0]&&o.label<s[1]){o.label=s[1],s=i;break}if(s&&o.label<s[2]){o.label=s[2],o.ops.push(i);break}s[2]&&o.ops.pop(),o.trys.pop();continue}i=t.call(e,o)}catch(e){i=[6,e],n=0}finally{r=s=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}}Object.create;function p(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function g(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,s,i=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)o.push(n.value)}catch(e){s={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(s)throw s.error}}return o}function m(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(g(arguments[t]));return e}Object.create;var v=function(){function e(){}return e.prototype.ngOnInit=function(){},e.ɵfac=function(t){return new(t||e)},e.ɵcmp=t.ɵɵdefineComponent({type:e,selectors:[["lib-hug-angular-lib"]],decls:2,vars:0,template:function(e,r){1&e&&(t.ɵɵelementStart(0,"p"),t.ɵɵtext(1," hug-fuck shit address "),t.ɵɵelementEnd())},encapsulation:2}),e}();console.log("NGX logger");var f=function(){function e(){}return e.ɵmod=t.ɵɵdefineNgModule({type:e}),e.ɵinj=t.ɵɵdefineInjector({factory:function(t){return new(t||e)},providers:[r.NGXLogger],imports:[[r.LoggerModule.forRoot({level:r.NgxLoggerLevel.DEBUG})]]}),e}();("undefined"==typeof ngJitMode||ngJitMode)&&t.ɵɵsetNgModuleScope(f,{declarations:[v],imports:[r.LoggerModule],exports:[v]});var b=function(){function e(){this.onLayerChange=new n.Subject,this.mediaStream=new MediaStream}return e.prototype.setConsumer=function(e){this.consumer=e,this.streamId=e.id,this.kind=e.kind,this.mediaStream.addTrack(e.track)},e.prototype.consumerLayerChanged=function(){this.mediaStream=new MediaStream,this.mediaStream.addTrack(this.consumer.track),this.onLayerChange.next()},e.prototype.setProducer=function(e){this.producer=e,this.mediaStream.addTrack(e.track)},e}(),_=function(e){function t(r){var n=e.call(this,r)||this;return n.name="SocketTimeoutError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(n,t):n.stack=new Error(r).stack,n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}u(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}(t,e),t}(Error),y=function(){function e(e){this.logger=e,this._closed=!1,this.onDisconnected=new n.Subject,this.onReconnecting=new n.Subject,this.onReconnected=new n.Subject,this.onNewConsumer=new n.Subject,this.onNotification=new n.Subject}return e.prototype.init=function(e){var t=this;this._closed=!1,this._signalingUrl,this._signalingSocket=c.io(e),this.logger.debug("Initialize socket ",this._signalingUrl),this._signalingSocket.on("connect",(function(){t.logger.debug('signaling Peer "connect" event')})),this._signalingSocket.on("disconnect",(function(e){t.logger.warn('signaling Peer "disconnect" event [reason:"%s"]',e),t._closed||("io server disconnect"===e&&(t.onDisconnected.next(),t.close()),t.onReconnecting.next)})),this._signalingSocket.on("reconnect_failed",(function(){t.logger.warn('signaling Peer "reconnect_failed" event'),t.onDisconnected.next(),t.close()})),this._signalingSocket.on("reconnect",(function(e){t.logger.debug('signaling Peer "reconnect" event [attempts:"%s"]',e),t.onReconnected.next(e)})),this._signalingSocket.on("request",(function(e,r){return l(t,void 0,void 0,(function(){return h(this,(function(t){switch(this.logger.debug('socket "request" event [method:"%s", data:"%o"]',e.method,e.data),e.method){case"newConsumer":this.onNewConsumer.next(e.data),r();break;default:this.logger.error('unknown request.method "%s"',e.method),r(500,'unknown request.method "'+e.method+'"')}return[2]}))}))})),this._signalingSocket.on("notification",(function(e){t.logger.debug('socket> "notification" event [method:"%s", data:"%o"]',e.method,e.data),t.onNotification.next(e)}))},e.prototype.close=function(){this._closed||(this._closed=!0,this.logger.debug("close()"),this._signalingSocket.close(),this._signalingSocket=null)},e.prototype.timeoutCallback=function(e){var t=!1,r=setTimeout((function(){t||(t=!0,e(new _("Request timed out")))}),2e4);return function(){for(var n=[],s=0;s<arguments.length;s++)n[s]=arguments[s];t||(t=!0,clearTimeout(r),e.apply(void 0,m(n)))}},e.prototype._sendRequest=function(e,t){var r=this;return new Promise((function(n,s){r._signalingSocket?r._signalingSocket.emit("request",{method:e,data:t},r.timeoutCallback((function(e,t){e?s(e):n(t)}))):s("No socket connection")}))},e.prototype.sendRequest=function(e,t){return l(this,void 0,void 0,(function(){var r,n,s;return h(this,(function(i){switch(i.label){case 0:this.logger.debug('sendRequest() [method:"%s", data:"%o"]',e,t),r=3,n=0,i.label=1;case 1:if(!(n<r))return[3,6];i.label=2;case 2:return i.trys.push([2,4,,5]),[4,this._sendRequest(e,t)];case 3:return[2,i.sent()];case 4:if(!((s=i.sent())instanceof _&&n<r))throw s;return this.logger.warn('sendRequest() | timeout, retrying [attempt:"%s"]',n),[3,5];case 5:return n++,[3,1];case 6:return[2]}}))}))},e.ɵfac=function(n){return new(n||e)(t.ɵɵinject(r.NGXLogger))},e.ɵprov=t.ɵɵdefineInjectable({token:e,factory:e.ɵfac,providedIn:"root"}),e}(),w=function(){this.streams=[]},P=function(){function e(e){this.logger=e,this._remotePeers=new n.BehaviorSubject([]),this.peers=[],this.remotePeers=this._remotePeers.asObservable()}return e.prototype.updatePeers=function(){var e=this;setTimeout((function(){return e._remotePeers.next(e.peers)}),0)},e.prototype.clearPeers=function(){this._remotePeers=new n.BehaviorSubject([]),this.remotePeers=this._remotePeers.asObservable(),this.peers=[]},e.prototype.newPeer=function(e){this.logger.debug("New peer",e);var t=new w;return t.id=e,t.streams=[],this.addPeer(t),this.updatePeers(),t},e.prototype.closePeer=function(e){this.logger.debug('room "peerClosed" event [peerId:%o]',e),this.peers=this.peers.filter((function(t){return t.id!==e})),this.updatePeers()},e.prototype.addPeer=function(e){this.peers.push(e)},e.prototype.addPeers=function(e){var t,r;this.logger.debug("Add peers ",e);var n=function(e){s.peers.find((function(t){return e.id===t.id}))||(s.logger.debug('adding peer [peerId: "%s"]',e.id),s.peers.push({id:e.id,streams:[]}))},s=this;try{for(var i=p(e),o=i.next();!o.done;o=i.next()){n(o.value)}}catch(e){t={error:e}}finally{try{o&&!o.done&&(r=i.return)&&r.call(i)}finally{if(t)throw t.error}}this.updatePeers()},e.prototype.newConsumer=function(e,t,r,n){this.logger.debug("remote peers New consumer",e,t);var s=this.peers.find((function(e){return e.id===t}));s||(this.logger.warn("Couldn't find peer",t,this.peers),s=this.newPeer(t));var i=s.streams.find((function(t){var r;return(null===(r=t.consumer)||void 0===r?void 0:r.appData.source)===e.appData.source}));if(i)i.setConsumer(e);else{var o=new b;o.peer=s,o.type=r,o.producerPaused=n,o.setConsumer(e),this.logger.debug("New stream created ",o),s.streams.push(o)}this.updatePeers()},e.prototype.onConsumerLayerChanged=function(e){var t=this.getStreamByConsumerId(e);t&&t.consumerLayerChanged()},e.prototype.getStreamByConsumerId=function(e){var t,r;try{for(var n=p(this.peers),s=n.next();!s.done;s=n.next()){var i=s.value.streams.find((function(t){return t.consumer.id===e}));if(i)return i}}catch(e){t={error:e}}finally{try{s&&!s.done&&(r=n.return)&&r.call(n)}finally{if(t)throw t.error}}return null},e.ɵfac=function(n){return new(n||e)(t.ɵɵinject(r.NGXLogger))},e.ɵprov=t.ɵɵdefineInjectable({token:e,factory:e.ɵfac,providedIn:"root"}),e}(),S=[{scaleResolutionDownBy:4},{scaleResolutionDownBy:2},{scaleResolutionDownBy:1}],k={low:{width:{ideal:320},aspectRatio:1.777},medium:{width:{ideal:640},aspectRatio:1.777},high:{width:{ideal:1280},aspectRatio:1.777},veryhigh:{width:{ideal:1920},aspectRatio:1.777},ultra:{width:{ideal:3840},aspectRatio:1.777}},D={optional:[{googDscp:!0}]},C=[{scaleResolutionDownBy:4,maxBitRate:1e5},{scaleResolutionDownBy:1,maxBitRate:12e5}],R=[{scalabilityMode:"S3T3_KEY"}],I=function(){function e(e,t,r){this.signalingService=e,this.logger=t,this.remotePeersService=r,this._sendTransport=null,this._recvTransport=null,this._closed=!1,this._produce=!0,this._forceTcp=!1,this.subscriptions=[],this.onCamProducing=new n.Subject,this.onVolumeChange=new n.Subject}return e.prototype.init=function(e){var t=void 0===e?{}:e,r=t.peerId,n=void 0===r?null:r,s=t.produce,i=void 0===s||s,o=t.forceTcp,a=void 0!==o&&o,c=t.muted,u=void 0!==c&&c;if(!n)throw new Error("Missing peerId");this.logger.debug("INIT Room ",n),this._closed=!1,this._produce=i,this._forceTcp=a,this._muted=u,this._device=this.deviceInfo(),this._peerId=n,this._roomId=null,this._mediasoupDevice=null,this._sendTransport=null,this._recvTransport=null,this._micProducer=null,this._hark=null,this._harkStream=null,this._webcamProducer=null,this._extraVideoProducers=new Map,this._webcams={},this._audioDevices={},this._audioOutputDevices={},this._consumers=new Map,this._useSimulcast=!0},e.prototype.close=function(){this.logger.debug("close()",this._closed),this._closed||(this._closed=!0,this.logger.debug("close()"),this.signalingService.close(),this._sendTransport&&this._sendTransport.close(),this._recvTransport&&this._recvTransport.close(),this.subscriptions.forEach((function(e){e.unsubscribe()})),this.disconnectLocalHark(),this.remotePeersService.clearPeers())},e.prototype._startDevicesListener=function(){var e=this;navigator.mediaDevices.addEventListener("devicechange",(function(){return l(e,void 0,void 0,(function(){return h(this,(function(e){switch(e.label){case 0:return this.logger.debug("_startDevicesListener() | navigator.mediaDevices.ondevicechange"),[4,this._updateAudioDevices()];case 1:return e.sent(),[4,this._updateWebcams()];case 2:return e.sent(),[4,this._updateAudioOutputDevices()];case 3:return e.sent(),[2]}}))}))}))},e.prototype.muteMic=function(){return l(this,void 0,void 0,(function(){var e;return h(this,(function(t){switch(t.label){case 0:this.logger.debug("muteMic()"),this._micProducer.pause(),t.label=1;case 1:return t.trys.push([1,3,,4]),[4,this.signalingService.sendRequest("pauseProducer",{producerId:this._micProducer.id})];case 2:return t.sent(),[3,4];case 3:return e=t.sent(),this.logger.error('muteMic() [error:"%o"]',e),[3,4];case 4:return[2]}}))}))},e.prototype.unmuteMic=function(){return l(this,void 0,void 0,(function(){var e;return h(this,(function(t){switch(t.label){case 0:return this.logger.debug("unmuteMic()"),this._micProducer?[3,1]:(this.updateMic({start:!0}),[3,5]);case 1:this._micProducer.resume(),t.label=2;case 2:return t.trys.push([2,4,,5]),[4,this.signalingService.sendRequest("resumeProducer",{producerId:this._micProducer.id})];case 3:return t.sent(),[3,5];case 4:return e=t.sent(),this.logger.error('unmuteMic() [error:"%o"]',e),[3,5];case 5:return[2]}}))}))},e.prototype.disconnectLocalHark=function(){if(this.logger.debug("disconnectLocalHark()"),null!=this._harkStream){var e=g(this._harkStream.getAudioTracks(),1)[0];e.stop(),e=null,this._harkStream=null}null!=this._hark&&this._hark.stop()},e.prototype.connectLocalHark=function(e){var t=this;this.logger.debug('connectLocalHark() [track:"%o"]',e),this._harkStream=new MediaStream;var r=e.clone();this._harkStream.addTrack(r),r.enabled=!0,this._hark=a(this._harkStream,{play:!1,interval:10,threshold:-50,history:100}),this._hark.lastVolume=-100,this._hark.on("volume_change",(function(e){t._micProducer&&Math.abs(e-t._hark.lastVolume)>.5&&(e<t._hark.lastVolume&&(e=t._hark.lastVolume-10*Math.pow((e-t._hark.lastVolume)/(100+t._hark.lastVolume),2)),t._hark.lastVolume=e)}))},e.prototype.changeAudioOutputDevice=function(e){return l(this,void 0,void 0,(function(){var t;return h(this,(function(r){switch(r.label){case 0:this.logger.debug('changeAudioOutputDevice() [deviceId:"%s"]',e),r.label=1;case 1:if(r.trys.push([1,3,,4]),!this._audioOutputDevices[e])throw new Error("Selected audio output device no longer available");return[4,this._updateAudioOutputDevices()];case 2:return r.sent(),[3,4];case 3:return t=r.sent(),this.logger.error('changeAudioOutputDevice() [error:"%o"]',t),[3,4];case 4:return[2]}}))}))},e.prototype.updateMic=function(e){var t=void 0===e?{}:e,r=t.start,n=void 0!==r&&r,s=t.restart,i=void 0===s?"firefox"!==this._device.flag:s,o=t.newDeviceId,a=void 0===o?null:o;return l(this,void 0,void 0,(function(){var e,t,r,s,o,c,u,d,l,p,m,v,f,b,_,y,w,P,S,k,D,C,R,I,x,T,j,M,O,q,A=this;return h(this,(function(h){switch(h.label){case 0:this.logger.debug('updateMic() [start:"%s", restart:"%s", newDeviceId:"%s"]',n,i,a),h.label=1;case 1:if(h.trys.push([1,13,,14]),!this._mediasoupDevice.canProduce("audio"))throw new Error("cannot produce audio");if(a&&!i)throw new Error("changing device requires restart");return[4,this._getAudioDeviceId()];case 2:if(t=h.sent(),!this._audioDevices[t])throw new Error("no audio devices");return r=!1,s=!0,o=!0,d=void 0===(u=(c={}).sampleRate)?96e3:u,p=void 0===(l=c.channelCount)?1:l,v=void 0===(m=c.volume)?1:m,b=void 0===(f=c.sampleSize)?16:f,y=void 0!==(_=c.opusStereo)&&_,P=void 0===(w=c.opusDtx)||w,k=void 0===(S=c.opusFec)||S,C=void 0===(D=c.opusPtime)?20:D,I=void 0===(R=c.opusMaxPlaybackRate)?96e3:R,i&&this._micProducer||n?(this.disconnectLocalHark(),this._micProducer?[4,this.disableMic()]:[3,4]):[3,7];case 3:h.sent(),h.label=4;case 4:return[4,navigator.mediaDevices.getUserMedia({audio:{deviceId:{ideal:t},sampleRate:d,channelCount:p,volume:v,autoGainControl:r,echoCancellation:s,noiseSuppression:o,sampleSize:b}})];case 5:return x=h.sent(),q=g(x.getAudioTracks(),1),e=q[0],e.getSettings().deviceId,T=this,[4,this._sendTransport.produce({track:e,codecOptions:{opusStereo:y,opusDtx:P,opusFec:k,opusPtime:C,opusMaxPlaybackRate:I},appData:{source:"mic"}})];case 6:return T._micProducer=h.sent(),this._micProducer.on("transportclose",(function(){A._micProducer=null})),this._micProducer.on("trackended",(function(){A.disableMic()})),this._micProducer.volume=0,this.connectLocalHark(e),[3,11];case 7:return this._micProducer?[4,(e=this._micProducer.track).applyConstraints({sampleRate:d,channelCount:p,volume:v,autoGainControl:r,echoCancellation:s,noiseSuppression:o,sampleSize:b})]:[3,11];case 8:return h.sent(),null==this._harkStream?[3,11]:(j=g(this._harkStream.getAudioTracks(),1),M=j[0],M?[4,M.applyConstraints({sampleRate:d,channelCount:p,volume:v,autoGainControl:r,echoCancellation:s,noiseSuppression:o,sampleSize:b})]:[3,10]);case 9:h.sent(),h.label=10;case 10:h.label=11;case 11:return[4,this._updateAudioDevices()];case 12:return h.sent(),[3,14];case 13:return O=h.sent(),this.logger.error('updateMic() [error:"%o"]',O),e&&e.stop(),[3,14];case 14:return[2]}}))}))},e.prototype.updateWebcam=function(e){var t=void 0===e?{}:e,r=(t.init,t.start),n=void 0!==r&&r,s=t.restart,i=void 0!==s&&s,o=t.newDeviceId,a=void 0===o?null:o,c=t.newResolution,u=void 0===c?null:c,m=t.newFrameRate,v=void 0===m?null:m;return l(this,void 0,void 0,(function(){var e,t,r,s,o,c,l,m,f,_,y,w,P,D,I,x,T,j,M=this;return h(this,(function(h){switch(h.label){case 0:this.logger.debug('updateWebcam() [start:"%s", restart:"%s", newDeviceId:"%s", newResolution:"%s", newFrameRate:"%s"]',n,i,a,u,v),h.label=1;case 1:if(h.trys.push([1,21,,22]),!this._mediasoupDevice.canProduce("video"))throw new Error("cannot produce video");if(a&&!i)throw new Error("changing device requires restart");return!1,[4,this._getWebcamDeviceId()];case 2:if(t=h.sent(),!this._webcams[t])throw new Error("no webcam devices");return r="medium",s=15,i&&this._webcamProducer||n?this._webcamProducer?[4,this.disableWebcam()]:[3,4]:[3,10];case 3:h.sent(),h.label=4;case 4:return[4,navigator.mediaDevices.getUserMedia({video:d(d({deviceId:{ideal:t}},k[r]),{frameRate:s})})];case 5:return o=h.sent(),x=g(o.getVideoTracks(),1),e=x[0],e.getSettings().deviceId,this._useSimulcast?(c=this._mediasoupDevice.rtpCapabilities.codecs.find((function(e){return"video"===e.kind})),l=void 0,l="video/vp9"===c.mimeType.toLowerCase()?R:S||C,m=this,[4,this._sendTransport.produce({track:e,encodings:l,codecOptions:{videoGoogleStartBitrate:1e3},appData:{source:"webcam"}})]):[3,7];case 6:return m._webcamProducer=h.sent(),[3,9];case 7:return f=this,[4,this._sendTransport.produce({track:e,appData:{source:"webcam"}})];case 8:f._webcamProducer=h.sent(),h.label=9;case 9:return(_=new b).setProducer(this._webcamProducer),this.onCamProducing.next(_),this._webcamProducer.on("transportclose",(function(){M._webcamProducer=null})),this._webcamProducer.on("trackended",(function(){M.disableWebcam()})),[3,19];case 10:return this._webcamProducer?[4,(e=this._webcamProducer.track).applyConstraints(d(d({},k[r]),{frameRate:s}))]:[3,19];case 11:h.sent(),h.label=12;case 12:h.trys.push([12,17,18,19]),y=p(this._extraVideoProducers.values()),w=y.next(),h.label=13;case 13:return w.done?[3,16]:(P=w.value,[4,(e=P.track).applyConstraints(d(d({},k[r]),{frameRate:s}))]);case 14:h.sent(),h.label=15;case 15:return w=y.next(),[3,13];case 16:return[3,19];case 17:return D=h.sent(),T={error:D},[3,19];case 18:try{w&&!w.done&&(j=y.return)&&j.call(y)}finally{if(T)throw T.error}return[7];case 19:return[4,this._updateWebcams()];case 20:return h.sent(),[3,22];case 21:return I=h.sent(),this.logger.error('updateWebcam() [error:"%o"]',I),e&&e.stop(),[3,22];case 22:return[2]}}))}))},e.prototype.closeMeeting=function(){return l(this,void 0,void 0,(function(){var e;return h(this,(function(t){switch(t.label){case 0:this.logger.debug("closeMeeting()"),t.label=1;case 1:return t.trys.push([1,3,,4]),[4,this.signalingService.sendRequest("moderator:closeMeeting")];case 2:return t.sent(),[3,4];case 3:return e=t.sent(),this.logger.error('closeMeeting() [error:"%o"]',e),[3,4];case 4:return[2]}}))}))},e.prototype.modifyPeerConsumer=function(e,t,r){return l(this,void 0,void 0,(function(){var n,s,i,o,a,c,u;return h(this,(function(d){switch(d.label){case 0:this.logger.debug('modifyPeerConsumer() [peerId:"%s", type:"%s"]',e,t),d.label=1;case 1:d.trys.push([1,12,,13]),d.label=2;case 2:d.trys.push([2,9,10,11]),n=p(this._consumers.values()),s=n.next(),d.label=3;case 3:return s.done?[3,8]:(i=s.value).appData.peerId!==e||i.appData.source!==t?[3,7]:r?[4,this._pauseConsumer(i)]:[3,5];case 4:return d.sent(),[3,7];case 5:return[4,this._resumeConsumer(i)];case 6:d.sent(),d.label=7;case 7:return s=n.next(),[3,3];case 8:return[3,11];case 9:return o=d.sent(),c={error:o},[3,11];case 10:try{s&&!s.done&&(u=n.return)&&u.call(n)}finally{if(c)throw c.error}return[7];case 11:return[3,13];case 12:return a=d.sent(),this.logger.error('modifyPeerConsumer() [error:"%o"]',a),[3,13];case 13:return[2]}}))}))},e.prototype._pauseConsumer=function(e){return l(this,void 0,void 0,(function(){var t;return h(this,(function(r){switch(r.label){case 0:if(this.logger.debug('_pauseConsumer() [consumer:"%o"]',e),e.paused||e.closed)return[2];r.label=1;case 1:return r.trys.push([1,3,,4]),[4,this.signalingService.sendRequest("pauseConsumer",{consumerId:e.id})];case 2:return r.sent(),e.pause(),[3,4];case 3:return t=r.sent(),this.logger.error('_pauseConsumer() [error:"%o"]',t),[3,4];case 4:return[2]}}))}))},e.prototype._resumeConsumer=function(e){return l(this,void 0,void 0,(function(){var t;return h(this,(function(r){switch(r.label){case 0:if(this.logger.debug('_resumeConsumer() [consumer:"%o"]',e),!e.paused||e.closed)return[2];r.label=1;case 1:return r.trys.push([1,3,,4]),[4,this.signalingService.sendRequest("resumeConsumer",{consumerId:e.id})];case 2:return r.sent(),e.resume(),[3,4];case 3:return t=r.sent(),this.logger.error('_resumeConsumer() [error:"%o"]',t),[3,4];case 4:return[2]}}))}))},e.prototype.join=function(e){var t=e.roomId,r=e.joinVideo,n=e.joinAudio,i=e.token;return l(this,void 0,void 0,(function(){var e=this;return h(this,(function(o){return this._roomId=t,this.signalingService.init(i),this.subscriptions.push(this.signalingService.onDisconnected.subscribe((function(){}))),this.subscriptions.push(this.signalingService.onReconnecting.subscribe((function(){e.logger.log("Reconnecting..."),e._webcamProducer&&(e._webcamProducer.close(),e._webcamProducer=null),e._micProducer&&(e._micProducer.close(),e._micProducer=null),e._sendTransport&&(e._sendTransport.close(),e._sendTransport=null),e._recvTransport&&(e._recvTransport.close(),e._recvTransport=null),e.remotePeersService.clearPeers()}))),this.subscriptions.push(this.signalingService.onNewConsumer.pipe(s.switchMap((function(t){return l(e,void 0,void 0,(function(){var e,r,n,s,i,o,a,c,u,l=this;return h(this,(function(h){switch(h.label){case 0:return e=t.peerId,r=t.producerId,n=t.id,s=t.kind,i=t.rtpParameters,o=t.type,a=t.appData,c=t.producerPaused,[4,this._recvTransport.consume({id:n,producerId:r,kind:s,rtpParameters:i,appData:d(d({},a),{peerId:e})})];case 1:return u=h.sent(),this._consumers.set(u.id,u),u.on("transportclose",(function(){l._consumers.delete(u.id)})),this.remotePeersService.newConsumer(u,e,o,c),[2]}}))}))}))).subscribe()),this.subscriptions.push(this.signalingService.onNotification.pipe(s.switchMap((function(t){return l(e,void 0,void 0,(function(){var e,s,i,o,a,c,u,d,l,p;return h(this,(function(h){switch(h.label){case 0:this.logger.debug('socket "notification" event [method:"%s", data:"%o"]',t.method,t.data),h.label=1;case 1:switch(h.trys.push([1,17,,18]),t.method){case"producerScore":return[3,2];case"newPeer":return[3,3];case"peerClosed":return[3,4];case"consumerClosed":return[3,5];case"consumerPaused":return[3,6];case"consumerResumed":return[3,7];case"consumerLayersChanged":return[3,8];case"consumerScore":return[3,9];case"roomBack":return[3,10];case"roomReady":return[3,12];case"activeSpeaker":return[3,14]}return[3,15];case 2:return e=t.data,e.producerId,e.score,[3,16];case 3:return s=t.data,i=s.id,s.displayName,s.picture,s.roles,this.remotePeersService.newPeer(i),[3,16];case 4:return l=t.data.peerId,this.remotePeersService.closePeer(l),[3,16];case 5:return u=t.data.consumerId,(a=this._consumers.get(u))?(a.close(),null!=a.hark&&a.hark.stop(),this._consumers.delete(u),l=a.appData.peerId,[3,16]):[3,16];case 6:case 7:return u=t.data.consumerId,a=this._consumers.get(u),[3,16];case 8:return o=t.data,u=o.consumerId,o.spatialLayer,o.temporalLayer,(a=this._consumers.get(u))?(this.remotePeersService.onConsumerLayerChanged(u),[3,16]):[3,16];case 9:return c=t.data,u=c.consumerId,c.score,[3,16];case 10:return[4,this._joinRoom({joinVideo:r,joinAudio:n})];case 11:return h.sent(),[3,16];case 12:return d=t.data.turnServers,this._turnServers=d,[4,this._joinRoom({joinVideo:r,joinAudio:n})];case 13:return h.sent(),[3,16];case 14:return(l=t.data.peerId)===this._peerId&&this.onVolumeChange.next(t.data),[3,16];case 15:h.label=16;case 16:return[3,18];case 17:return p=h.sent(),this.logger.error('error on socket "notification" event [error:"%o"]',p),[3,18];case 18:return[2]}}))}))}))).subscribe()),[2]}))}))},e.prototype._updateAudioDevices=function(){return l(this,void 0,void 0,(function(){var e,t,r,n,s,i,o;return h(this,(function(a){switch(a.label){case 0:this.logger.debug("_updateAudioDevices()"),this._audioDevices={},a.label=1;case 1:return a.trys.push([1,3,,4]),this.logger.debug("_updateAudioDevices() | calling enumerateDevices()"),[4,navigator.mediaDevices.enumerateDevices()];case 2:e=a.sent();try{for(t=p(e),r=t.next();!r.done;r=t.next())"audioinput"===(n=r.value).kind&&(this._audioDevices[n.deviceId]=n)}catch(e){i={error:e}}finally{try{r&&!r.done&&(o=t.return)&&o.call(t)}finally{if(i)throw i.error}}return[3,4];case 3:return s=a.sent(),this.logger.error('_updateAudioDevices() [error:"%o"]',s),[3,4];case 4:return[2]}}))}))},e.prototype._updateWebcams=function(){return l(this,void 0,void 0,(function(){var e,t,r,n,s,i,o;return h(this,(function(a){switch(a.label){case 0:this.logger.debug("_updateWebcams()"),this._webcams={},a.label=1;case 1:return a.trys.push([1,3,,4]),this.logger.debug("_updateWebcams() | calling enumerateDevices()"),[4,navigator.mediaDevices.enumerateDevices()];case 2:e=a.sent();try{for(t=p(e),r=t.next();!r.done;r=t.next())"videoinput"===(n=r.value).kind&&(this._webcams[n.deviceId]=n)}catch(e){i={error:e}}finally{try{r&&!r.done&&(o=t.return)&&o.call(t)}finally{if(i)throw i.error}}return[3,4];case 3:return s=a.sent(),this.logger.error('_updateWebcams() [error:"%o"]',s),[3,4];case 4:return[2]}}))}))},e.prototype.disableWebcam=function(){return l(this,void 0,void 0,(function(){var e;return h(this,(function(t){switch(t.label){case 0:if(this.logger.debug("disableWebcam()"),!this._webcamProducer)return[2];this._webcamProducer.close(),t.label=1;case 1:return t.trys.push([1,3,,4]),[4,this.signalingService.sendRequest("closeProducer",{producerId:this._webcamProducer.id})];case 2:return t.sent(),[3,4];case 3:return e=t.sent(),this.logger.error('disableWebcam() [error:"%o"]',e),[3,4];case 4:return this._webcamProducer=null,[2]}}))}))},e.prototype.disableMic=function(){return l(this,void 0,void 0,(function(){var e;return h(this,(function(t){switch(t.label){case 0:if(this.logger.debug("disableMic()"),!this._micProducer)return[2];this._micProducer.close(),t.label=1;case 1:return t.trys.push([1,3,,4]),[4,this.signalingService.sendRequest("closeProducer",{producerId:this._micProducer.id})];case 2:return t.sent(),[3,4];case 3:return e=t.sent(),this.logger.error('disableMic() [error:"%o"]',e),[3,4];case 4:return this._micProducer=null,[2]}}))}))},e.prototype._getWebcamDeviceId=function(){return l(this,void 0,void 0,(function(){var e,t;return h(this,(function(r){switch(r.label){case 0:this.logger.debug("_getWebcamDeviceId()"),r.label=1;case 1:return r.trys.push([1,3,,4]),this.logger.debug("_getWebcamDeviceId() | calling _updateWebcams()"),[4,this._updateWebcams()];case 2:return r.sent(),null,[2,(e=Object.values(this._webcams))[0]?e[0].deviceId:null];case 3:return t=r.sent(),this.logger.error('_getWebcamDeviceId() [error:"%o"]',t),[3,4];case 4:return[2]}}))}))},e.prototype._getAudioDeviceId=function(){return l(this,void 0,void 0,(function(){var e,t;return h(this,(function(r){switch(r.label){case 0:this.logger.debug("_getAudioDeviceId()"),r.label=1;case 1:return r.trys.push([1,3,,4]),this.logger.debug("_getAudioDeviceId() | calling _updateAudioDeviceId()"),[4,this._updateAudioDevices()];case 2:return r.sent(),null,[2,(e=Object.values(this._audioDevices))[0]?e[0].deviceId:null];case 3:return t=r.sent(),this.logger.error('_getAudioDeviceId() [error:"%o"]',t),[3,4];case 4:return[2]}}))}))},e.prototype._updateAudioOutputDevices=function(){return l(this,void 0,void 0,(function(){var e,t,r,n,s,i,o;return h(this,(function(a){switch(a.label){case 0:this.logger.debug("_updateAudioOutputDevices()"),this._audioOutputDevices={},a.label=1;case 1:return a.trys.push([1,3,,4]),this.logger.debug("_updateAudioOutputDevices() | calling enumerateDevices()"),[4,navigator.mediaDevices.enumerateDevices()];case 2:e=a.sent();try{for(t=p(e),r=t.next();!r.done;r=t.next())"audiooutput"===(n=r.value).kind&&(this._audioOutputDevices[n.deviceId]=n)}catch(e){i={error:e}}finally{try{r&&!r.done&&(o=t.return)&&o.call(t)}finally{if(i)throw i.error}}return[3,4];case 3:return s=a.sent(),this.logger.error('_updateAudioOutputDevices() [error:"%o"]',s),[3,4];case 4:return[2]}}))}))},e.prototype._joinRoom=function(e){var t=e.joinVideo,r=e.joinAudio;return l(this,void 0,void 0,(function(){var e,n,s,i,a,c,u,d,p,g,m,v,f,b,_,y,w,P,S=this;return h(this,(function(k){switch(k.label){case 0:this.logger.debug("_joinRoom() Device",this._device),e="Guest "+(Math.floor(9e4*Math.random())+1e4),k.label=1;case 1:return k.trys.push([1,11,,12]),this._mediasoupDevice=new o.Device({handlerName:"Safari12"}),[4,this.signalingService.sendRequest("getRouterRtpCapabilities")];case 2:return(n=k.sent()).headerExtensions=n.headerExtensions.filter((function(e){return"urn:3gpp:video-orientation"!==e.uri})),[4,this._mediasoupDevice.load({routerRtpCapabilities:n})];case 3:return k.sent(),this._produce?[4,this.signalingService.sendRequest("createWebRtcTransport",{forceTcp:this._forceTcp,producing:!0,consuming:!1})]:[3,5];case 4:s=k.sent(),i=s.id,a=s.iceParameters,c=s.iceCandidates,u=s.dtlsParameters,this._sendTransport=this._mediasoupDevice.createSendTransport({id:i,iceParameters:a,iceCandidates:c,dtlsParameters:u,iceServers:this._turnServers,iceTransportPolicy:"firefox"===this._device.flag&&this._turnServers?"relay":void 0,proprietaryConstraints:D}),this._sendTransport.on("connect",(function(e,t,r){var n=e.dtlsParameters;S.signalingService.sendRequest("connectWebRtcTransport",{transportId:S._sendTransport.id,dtlsParameters:n}).then(t).catch(r)})),this._sendTransport.on("produce",(function(e,t,r){var n=e.kind,s=e.rtpParameters,i=e.appData;return l(S,void 0,void 0,(function(){var e,o;return h(this,(function(a){switch(a.label){case 0:return a.trys.push([0,2,,3]),[4,this.signalingService.sendRequest("produce",{transportId:this._sendTransport.id,kind:n,rtpParameters:s,appData:i})];case 1:return e=a.sent().id,t({id:e}),[3,3];case 2:return o=a.sent(),r(o),[3,3];case 3:return[2]}}))}))})),k.label=5;case 5:return[4,this.signalingService.sendRequest("createWebRtcTransport",{forceTcp:this._forceTcp,producing:!1,consuming:!0})];case 6:return d=k.sent(),p=d.id,g=d.iceParameters,m=d.iceCandidates,v=d.dtlsParameters,this._recvTransport=this._mediasoupDevice.createRecvTransport({id:p,iceParameters:g,iceCandidates:m,dtlsParameters:v,iceServers:this._turnServers,iceTransportPolicy:"firefox"===this._device.flag&&this._turnServers?"relay":void 0}),this._recvTransport.on("connect",(function(e,t,r){var n=e.dtlsParameters;S.signalingService.sendRequest("connectWebRtcTransport",{transportId:S._recvTransport.id,dtlsParameters:n}).then(t).catch(r)})),[4,this.signalingService.sendRequest("join",{displayName:e,rtpCapabilities:this._mediasoupDevice.rtpCapabilities})];case 7:return f=k.sent(),b=f.authenticated,_=f.roles,y=f.peers,f.tracker,f.roomPermissions,w=f.userRoles,f.allowWhenRoleMissing,f.chatHistory,f.fileHistory,f.lastNHistory,f.locked,f.lobbyPeers,f.accessCode,this.logger.debug('_joinRoom() joined [authenticated:"%s", peers:"%o", roles:"%o", userRoles:"%o"]',b,y,_,w),this.logger.debug("join audio",r,"can produce audio",this._mediasoupDevice.canProduce("audio")," this._muted",this._muted),this._produce?(t&&this.updateWebcam({init:!0,start:!0}),r&&this._mediasoupDevice.canProduce("audio")?this._muted?[3,9]:[4,this.updateMic({start:!0})]:[3,9]):[3,9];case 8:k.sent(),k.label=9;case 9:return[4,this._updateAudioOutputDevices()];case 10:return k.sent(),this.remotePeersService.addPeers(y),[3,12];case 11:return P=k.sent(),this.logger.error('_joinRoom() [error:"%o"]',P),this.close(),[3,12];case 12:return[2]}}))}))},e.prototype.deviceInfo=function(){var e=navigator.userAgent,t=i.getParser(e);return{flag:t.satisfies({chrome:">=0",chromium:">=0"})?"chrome":t.satisfies({firefox:">=0"})?"firefox":t.satisfies({safari:">=0"})?"safari":t.satisfies({opera:">=0"})?"opera":t.satisfies({"microsoft edge":">=0"})?"edge":"unknown",os:t.getOSName(!0),platform:t.getPlatformType(!0),name:t.getBrowserName(!0),version:t.getBrowserVersion(),bowser:t}},e.ɵfac=function(n){return new(n||e)(t.ɵɵinject(y),t.ɵɵinject(r.NGXLogger),t.ɵɵinject(P))},e.ɵprov=t.ɵɵdefineInjectable({token:e,factory:e.ɵfac,providedIn:"root"}),e}();Object.defineProperty(e,"LogService",{enumerable:!0,get:function(){return r.NGXLogger}}),e.HugAngularLibComponent=v,e.HugAngularLibModule=f,e.RemotePeersService=P,e.RoomService=I,e.Stream=b,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=hug-angular-lib.umd.min.js.map